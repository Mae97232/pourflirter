<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Param√®tres ‚Äì Pourflirter</title>
  <link rel="icon" href="Image/favicon.ico.jpg" />
  <link rel="stylesheet" href="Design/parametre.css">
</head>

<body>

<header class="header">
  <div class="logo">üíô <a href="accueil.html">Pourflirter</a></div>

  <div class="search-bar">
    <input type="text" placeholder="Recherche... (optionnel)">
  </div>

  <nav class="nav-links">
    <a href="message.html">Messages</a>
    <a href="#">Cr√©dits (50)</a>
    <a href="#" id="logout">D√©connexion</a>
  </nav>
</header>

<div class="layout">

  <main class="main-content">

    <section class="card">
      <h1 class="title">Param√®tres</h1>
      <p class="subtitle">Modifie tes informations.</p>

      <div class="grid">
        <!-- BLOQU√âS -->
        <div class="field">
          <label for="username">Pseudo</label>
          <input id="username" type="text" readonly>
        </div>

        <div class="field">
          <label for="birthdate">Date de naissance</label>
          <input id="birthdate" type="date" readonly>
        </div>

        <div class="field">
          <label for="gender">Sexe</label>
          <select id="gender" disabled>
            <option value="">Non renseign√©</option>
            <option value="homme">Homme</option>
            <option value="femme">Femme</option>
          </select>
        </div>

        <!-- MODIFIABLES -->
        <div class="field">
          <label for="lookingFor">Recherche</label>
          <select id="lookingFor">
            <option value="">Non renseign√©</option>
            <option value="homme">Homme</option>
            <option value="femme">Femme</option>
            <option value="les deux">Les deux</option>
          </select>
        </div>

        <div class="field suggest-box full">
          <label for="city">Ville (g√©ocod√©e)</label>

          <div class="row">
            <div class="grow">
              <input id="city" type="text" placeholder="ex: Le Havre">
              <div class="suggestions" id="city-suggestions"></div>
            </div>

            <div class="fixed">
              <button class="btn btn-ghost" id="btn-geo" type="button">Rechercher</button>
            </div>
          </div>

          <input id="city_lat" type="hidden">
          <input id="city_lon" type="hidden">

          <div class="status" id="geo-status"></div>
        </div>

        <div class="field">
          <label for="radius">Rayon de recherche</label>
          <select id="radius">
            <option value="5">5 km</option>
            <option value="10">10 km</option>
            <option value="20">20 km</option>
            <option value="50">50 km</option>
            <option value="100">100 km</option>
          </select>
        </div>

        <div class="field">
          <label for="country">Pays (optionnel)</label>
          <input id="country" type="text" placeholder="ex: France">
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-ghost" id="btn-reload" type="button">Recharger</button>
        <button class="btn btn-primary" id="btn-save" type="button">Enregistrer</button>
      </div>

      <div class="status" id="save-status"></div>
    </section>

  </main>

  <aside class="sidebar-right">
    <a href="mes-photos.html">Mes Photos</a>
    <a href="profil.html">Mon Profil</a>
    <a href="mes-favoris.html">Mes Favoris</a>
    <a href="membres_bloques.html">Membres Bloqu√©s</a>
    <a href="achat_credits.html">Acheter Cr√©dits</a>
    <a href="parametre.html" class="active">Param√®tres</a>
  </aside>

</div>

<footer class="footer">
  <a href="#">Service Clients</a>
  <a href="#">CGV</a>
  <a href="#">Protection des donn√©es</a>
  <a href="#">Mentions l√©gales</a>
  <a href="#">EN / FR</a>
  <div>¬© 2025 Pourflirter. Tous droits r√©serv√©s.</div>
</footer>

<script type="module">
  import { supabase } from "./supabaseClient.js";

  const { data: { session } } = await supabase.auth.getSession();
  if (!session) window.location.replace("index.html");
  const myId = session.user.id;

  const $ = (id) => document.getElementById(id);

  const usernameEl = $("username");
  const birthdateEl = $("birthdate");
  const genderEl = $("gender");

  const lookingForEl = $("lookingFor");
  const cityEl = $("city");
  const latEl = $("city_lat");
  const lonEl = $("city_lon");
  const radiusEl = $("radius");
  const countryEl = $("country");

  const saveStatus = $("save-status");
  const geoStatus = $("geo-status");
  const suggBox = $("city-suggestions");

  function setStatus(el, msg, type="") {
    el.className = "status" + (type ? " " + type : "");
    el.textContent = msg || "";
  }

  async function loadMe() {
    setStatus(saveStatus, "Chargement...", "");

    const { data, error } = await supabase
      .from("profiles")
      .select("id, username, birthdate, gender, lookingFor, birthplace, country, search_radius, city_lat, city_lon")
      .eq("id", myId)
      .maybeSingle();

    if (error) {
      console.error(error);
      setStatus(saveStatus, "‚ùå Erreur chargement : " + error.message, "err");
      return;
    }

    if (!data) {
      setStatus(saveStatus, "‚ùå Profil introuvable.", "err");
      return;
    }

    // Affich√©s (bloqu√©s)
    usernameEl.value = data.username ?? "";
    birthdateEl.value = data.birthdate ?? "";
    genderEl.value = data.gender ?? "";

    // Modifiables
    lookingForEl.value = data.lookingFor ?? "";
    cityEl.value = data.birthplace ?? "";
    radiusEl.value = String(data.search_radius ?? 20);
    countryEl.value = data.country ?? "";
    latEl.value = data.city_lat ?? "";
    lonEl.value = data.city_lon ?? "";

    setStatus(saveStatus, "‚úÖ Profil charg√©.", "ok");
  }

  let geoTimer = null;

  function closeSuggestions() {
    suggBox.classList.remove("open");
    suggBox.innerHTML = "";
  }

  async function geocodeCity(query) {
    const q = (query || "").trim();
    if (q.length < 2) {
      closeSuggestions();
      setStatus(geoStatus, "", "");
      return;
    }

    setStatus(geoStatus, "Recherche de la ville‚Ä¶", "");

    try {
      const url =
        "https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=6&q=" +
        encodeURIComponent(q);

      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error("HTTP " + res.status);

      const items = await res.json();

      if (!Array.isArray(items) || items.length === 0) {
        closeSuggestions();
        setStatus(geoStatus, "Aucun r√©sultat.", "err");
        return;
      }

      suggBox.innerHTML = "";
      items.forEach((it) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = it.display_name;

        btn.onclick = () => {
          const city =
            it.address?.city ||
            it.address?.town ||
            it.address?.village ||
            it.address?.municipality ||
            it.address?.county ||
            it.display_name;

          cityEl.value = city;
          latEl.value = it.lat || "";
          lonEl.value = it.lon || "";
          if (it.address?.country) countryEl.value = it.address.country;

          closeSuggestions();
          setStatus(geoStatus, "‚úÖ Ville s√©lectionn√©e.", "ok");
        };

        suggBox.appendChild(btn);
      });

      suggBox.classList.add("open");
      setStatus(geoStatus, "Choisis une suggestion pour valider.", "");
    } catch (e) {
      console.error(e);
      closeSuggestions();
      setStatus(geoStatus, "‚ùå Erreur g√©ocodage : " + e.message, "err");
    }
  }

  cityEl.addEventListener("input", () => {
    latEl.value = "";
    lonEl.value = "";
    if (geoTimer) clearTimeout(geoTimer);
    geoTimer = setTimeout(() => geocodeCity(cityEl.value), 450);
  });

  $("btn-geo").addEventListener("click", () => geocodeCity(cityEl.value));

  document.addEventListener("click", (e) => {
    if (!e.target.closest(".suggest-box")) closeSuggestions();
  });

  async function saveMe() {
    setStatus(saveStatus, "Enregistrement‚Ä¶", "");

    // ‚úÖ ON SAUVE UNIQUEMENT les champs modifiables
    const payload = {
      lookingFor: lookingForEl.value || null,
      birthplace: cityEl.value.trim() || null,
      country: countryEl.value.trim() || null,
      search_radius: Number(radiusEl.value || 20),
      city_lat: latEl.value ? Number(latEl.value) : null,
      city_lon: lonEl.value ? Number(lonEl.value) : null
    };

    const { error } = await supabase
      .from("profiles")
      .update(payload)
      .eq("id", myId);

    if (error) {
      console.error(error);
      setStatus(saveStatus, "‚ùå Erreur : " + error.message, "err");
      return;
    }

    setStatus(saveStatus, "‚úÖ Enregistr√©.", "ok");
  }

  $("btn-save").addEventListener("click", saveMe);
  $("btn-reload").addEventListener("click", loadMe);

  $("logout").addEventListener("click", async (e) => {
    e.preventDefault();
    await supabase.auth.signOut();
    window.location.replace("index.html");
  });

  await loadMe();
</script>

</body>
</html>

