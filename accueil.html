<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Accueil - Pourflirter</title>
  <link rel="stylesheet" href="Design/accueil.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

  <header class="header">
    <div class="logo">üíô Pourflirter</div>
    <div class="search-bar"><input type="text" placeholder="Recherche..."></div>
    <nav class="nav-links">
      <a href="message.html">Messages</a>
      <a href="#">Cr√©dits (50)</a>
      <a href="#" id="logout">D√©connexion</a>
    </nav>
  </header>

  <div class="layout">
    <!-- Profil utilisateur connect√© -->
    <aside class="sidebar-left" id="user-profile"></aside>

    <!-- Contenu principal -->
    <main class="main-content">

      <!-- Suggestions -->
      <section class="profile-section">
        <h2 class="section-title">Suggestions</h2>
        <div class="profiles-row" id="suggestions"></div>
        <button class="show-more" id="suggestions-more" type="button">Afficher plus</button>
      </section>

      <!-- En ligne -->
      <section class="profile-section">
        <h2 class="section-title">En ligne</h2>
        <div class="profiles-row" id="en-ligne"></div>
        <button class="show-more" id="en-ligne-more" type="button">Afficher plus</button>
      </section>

      <!-- Derniers visiteurs -->
      <section class="profile-section">
        <h2 class="section-title">Derniers visiteurs</h2>
        <div class="profiles-row" id="visiteurs"></div>
        <button class="show-more" id="visiteurs-more" type="button">Afficher plus</button>
      </section>

    </main>

    <!-- Sidebar droite -->
    <aside class="sidebar-right">
      <a href="mes-photos.html">Mes Photos</a>
      <a href="profil.html">Mon Profil</a>
      <a href="mes-favoris.html">Mes Favoris</a>
      <a href="membres_bloques.html">Membres Bloqu√©s</a>
      <a href="achat_credits.html">Acheter Cr√©dits</a>
      <a href="parametre.html">Param√®tres</a>
    </aside>
  </div>

  <footer class="footer">
    <a href="#">Service Clients</a>
    <a href="#">CGV</a>
    <a href="#">Protection des donn√©es</a>
    <a href="#">Mentions l√©gales</a>
    <a href="#">EN / FR</a>
    <div>¬© 2025 Pourflirter. Tous droits r√©serv√©s.</div>
  </footer>

  <script type="module">
    import { supabase } from "./supabaseClient.js";

    // ‚úÖ Session
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) window.location.replace("index.html");
    const myId = session.user.id;

    // ‚úÖ Assure que mon profil existe
    await supabase.from("profiles").upsert({ id: myId }, { onConflict: "id" });

    // =========================================================
    // Helpers UI
    // =========================================================
    const $ = (id) => document.getElementById(id);

    function norm(v) {
      return String(v || "").trim().toLowerCase();
    }

    /* -------------------------------------------------------
       ‚úÖ Signed URL photo profil (bucket priv√© profile_photos)
    -------------------------------------------------------- */
    async function getProfilePhotoUrl(photoValue) {
      if (!photoValue) return "default.jpg";
      if (typeof photoValue === "string" && photoValue.startsWith("http")) {
        return photoValue + (photoValue.includes("?") ? "&" : "?") + "t=" + Date.now();
      }
      const { data, error } = await supabase.storage
        .from("profile_photos")
        .createSignedUrl(photoValue, 60 * 60);

      if (error) {
        console.error("SignedUrl photo profil:", error);
        return "default.jpg";
      }
      return data.signedUrl + (data.signedUrl.includes("?") ? "&" : "?") + "t=" + Date.now();
    }

    /* -------------------------------------------------------
       ‚úÖ G√©ocodage ville (Nominatim)
    -------------------------------------------------------- */
    async function geocodeCity(city) {
      if (!city || !city.trim()) return null;
      const q = encodeURIComponent(city.trim());
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${q}&accept-language=fr`;
      try {
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if (!res.ok) return null;
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) return null;
        return { lat: Number(data[0].lat), lon: Number(data[0].lon) };
      } catch (e) {
        console.error("geocodeCity error:", e);
        return null;
      }
    }

    /* -------------------------------------------------------
       ‚úÖ Distance (Haversine km)
    -------------------------------------------------------- */
    function distanceKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const toRad = (v) => (v * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // =========================================================
    // Donn√©es globales
    // =========================================================
    let myProfile = null;
    let blockedSet = new Set();

    let suggestionsAll = [];
    let onlineAll = [];
    let visitorsAll = [];

    const LIMIT_DEFAULT = 4;
    const LIMIT_MORE = 12;

    const state = {
      suggestions: { limit: LIMIT_DEFAULT, expanded: false },
      "en-ligne": { limit: LIMIT_DEFAULT, expanded: false },
      visiteurs: { limit: LIMIT_DEFAULT, expanded: false },
    };

    // =========================================================
    // Exclusion bloqu√©s (dans les 2 sens)
    // Table suppos√©e: blocked_users(blocker_id uuid, blocked_id uuid)
    // =========================================================
    async function loadBlockedIds() {
      // On r√©cup√®re tous les blocs o√π je suis impliqu√© (blocker_id == moi OU blocked_id == moi)
      const { data, error } = await supabase
        .from("blocked_users")
        .select("blocker_id, blocked_id")
        .or(`blocker_id.eq.${myId},blocked_id.eq.${myId}`)
        .limit(500);

      if (error) {
        console.warn("loadBlockedIds:", error.message);
        blockedSet = new Set();
        return;
      }

      const s = new Set();
      (data || []).forEach((r) => {
        // Si j'ai bloqu√© quelqu'un => on exclut blocked_id
        if (r.blocker_id === myId && r.blocked_id) s.add(r.blocked_id);
        // Si quelqu'un m'a bloqu√© => on exclut blocker_id
        if (r.blocked_id === myId && r.blocker_id) s.add(r.blocker_id);
      });

      blockedSet = s;
    }

    function isBlocked(id) {
      return blockedSet.has(id);
    }

    // =========================================================
    // Filtre rayon
    // =========================================================
    function withinMyRadius(p) {
      const myLat = Number(myProfile?.city_lat);
      const myLon = Number(myProfile?.city_lon);
      const r = Number(myProfile?.search_radius ?? 20);

      // si je n'ai pas de coords -> pas de filtre
      if (!Number.isFinite(myLat) || !Number.isFinite(myLon)) return true;

      const lat = Number(p.city_lat);
      const lon = Number(p.city_lon);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return false;

      return distanceKm(myLat, myLon, lat, lon) <= r;
    }

    // =========================================================
    // Filtre lookingFor (Suggestions)
    // =========================================================
    function matchLookingFor(p) {
      const lf = norm(myProfile?.lookingFor);
      if (!lf || lf === "les deux") return true;
      return norm(p.gender) === lf;
    }

    // =========================================================
    // Afficher cartes (format ‚Äúligne de 4‚Äù)
    // =========================================================
    async function renderRow(containerId, list) {
      const container = $(containerId);
      container.innerHTML = "";

      const myLat = Number(myProfile?.city_lat);
      const myLon = Number(myProfile?.city_lon);

      const cards = await Promise.all(
        (list || []).map(async (p) => {
          const photoUrl = await getProfilePhotoUrl(p.photo);

          let distTxt = "";
          const lat = Number(p.city_lat);
          const lon = Number(p.city_lon);
          if (Number.isFinite(myLat) && Number.isFinite(myLon) && Number.isFinite(lat) && Number.isFinite(lon)) {
            distTxt = ` ‚Ä¢ ${Math.round(distanceKm(myLat, myLon, lat, lon))} km`;
          }

          return `
            <div class="mini-card" onclick="openProfile('${p.id}')">
              <img src="${photoUrl}" alt="">
              <div class="mini-info">
                <div class="mini-username">${p.username || ""}${distTxt}</div>
                <div class="mini-details">${p.gender || ""} (${p.birthplace || ""})</div>
              </div>
            </div>
          `;
        })
      );

      container.innerHTML = cards.join("");
    }

    function applyShowMoreButton(sectionKey, totalCount) {
      const btnId = sectionKey + "-more";
      const btn = $(btnId);
      const st = state[sectionKey];

      if (!btn) return;

      if (totalCount <= LIMIT_DEFAULT) {
        btn.style.display = "none";
        return;
      }
      btn.style.display = "inline-block";
      btn.textContent = st.expanded ? "Afficher moins" : "Afficher plus";
    }

    async function renderSection(sectionKey, fullList) {
      const st = state[sectionKey];
      const visible = (fullList || []).slice(0, st.limit);
      await renderRow(sectionKey, visible);
      applyShowMoreButton(sectionKey, (fullList || []).length);
    }

    function toggleMore(sectionKey) {
      const st = state[sectionKey];
      st.expanded = !st.expanded;
      st.limit = st.expanded ? LIMIT_MORE : LIMIT_DEFAULT;

      if (sectionKey === "suggestions") renderSection("suggestions", suggestionsAll);
      if (sectionKey === "en-ligne") renderSection("en-ligne", onlineAll);
      if (sectionKey === "visiteurs") renderSection("visiteurs", visitorsAll);
    }

    // =========================================================
    // Profil gauche
    // =========================================================
    async function loadMyProfile() {
      const { data: user, error } = await supabase
        .from("profiles")
        .select("id, username, gender, lookingFor, birthplace, adhesion, adeptes, contacts, photo, search_radius, city_lat, city_lon")
        .eq("id", myId)
        .maybeSingle();

      if (error || !user) {
        console.error("Erreur loadMyProfile:", error);
        return;
      }

      // ‚úÖ si je n'ai pas city_lat/city_lon -> g√©ocode MA ville et update DB
      if ((!Number.isFinite(user.city_lat) || !Number.isFinite(user.city_lon)) && user.birthplace) {
        const geo = await geocodeCity(user.birthplace);
        if (geo && Number.isFinite(geo.lat) && Number.isFinite(geo.lon)) {
          const { error: upErr } = await supabase
            .from("profiles")
            .update({ city_lat: geo.lat, city_lon: geo.lon })
            .eq("id", myId);

          if (!upErr) {
            user.city_lat = geo.lat;
            user.city_lon = geo.lon;
          }
        }
      }

      myProfile = user;

      const photoUrl = await getProfilePhotoUrl(user.photo);

      $("user-profile").innerHTML = `
        <div class="profile-card">
          <img src="${photoUrl}" alt="Photo de profil">
          <h3 class="username">${user.username || ""}</h3>
          <p class="info">${user.gender || 'Non renseign√©'}</p>
          <button class="certif-btn">Faites vous certifier !</button>
          <p class="localisation">(${user.birthplace || 'Inconnu'})</p>
          <div class="stats">
            <div style="cursor:pointer" onclick="location.href='relations.html?type=adhesion'">
              <strong>${user.adhesion ?? 0}</strong><br>Adh√©sion
            </div>
            <div style="cursor:pointer" onclick="location.href='relations.html?type=adeptes'">
              <strong>${user.adeptes ?? 0}</strong><br>Adeptes
            </div>
            <div style="cursor:pointer" onclick="location.href='relations.html?type=contacts'">
              <strong>${user.contacts ?? 0}</strong><br>Contacts
            </div>
          </div>
        </div>
      `;
    }

    // =========================================================
    // Visites : d√©dupliquer ‚Äú√† la Wyylde‚Äù
    // On garde 1 seul profil par visitor_id (le plus r√©cent)
    // =========================================================
    function dedupeVisitors(rows) {
      const seen = new Set();
      const uniq = [];
      for (const r of (rows || [])) {
        const id = r.visitor_id;
        if (!id) continue;
        if (seen.has(id)) continue;
        seen.add(id);
        uniq.push(id);
      }
      return uniq;
    }

    // =========================================================
    // Data loaders
    // =========================================================
    async function loadSuggestions() {
      const { data, error } = await supabase
        .from("profiles")
        .select("id, username, gender, birthplace, photo, city_lat, city_lon")
        .neq("id", myId)
        .limit(80);

      if (error) console.error("loadSuggestions:", error);

      suggestionsAll = (data || [])
        .filter(p => p?.id && !isBlocked(p.id))
        .filter(withinMyRadius)
        .filter(matchLookingFor)
        .slice(0, 60);

      await renderSection("suggestions", suggestionsAll);
    }

    async function loadOnline() {
      const since = new Date(Date.now() - 3 * 60 * 1000).toISOString();

      const { data: onlineRows, error } = await supabase
        .from("online_users")
        .select("user_id, last_seen")
        .gte("last_seen", since)
        .limit(100);

      if (error) {
        console.error("loadOnline:", error);
        onlineAll = [];
        return renderSection("en-ligne", onlineAll);
      }

      const ids = (onlineRows || [])
        .map(x => x.user_id)
        .filter(id => id && id !== myId && !isBlocked(id));

      if (ids.length === 0) {
        onlineAll = [];
        return renderSection("en-ligne", onlineAll);
      }

      const { data: profs, error: pErr } = await supabase
        .from("profiles")
        .select("id, username, gender, birthplace, photo, city_lat, city_lon")
        .in("id", ids);

      if (pErr) {
        console.error("loadOnline profiles:", pErr);
        onlineAll = [];
        return renderSection("en-ligne", onlineAll);
      }

      onlineAll = (profs || [])
        .filter(p => p?.id && p.id !== myId && !isBlocked(p.id))
        .filter(withinMyRadius)
        .slice(0, 100);

      await renderSection("en-ligne", onlineAll);
    }

    async function loadVisitors() {
      // On prend ‚Äúlarge‚Äù puis on d√©duplique
      const { data: rows, error } = await supabase
        .from("visits")
        .select("visitor_id, created_at")
        .eq("visited_id", myId)
        .order("created_at", { ascending: false })
        .limit(120);

      if (error) {
        console.error("loadVisitors:", error);
        visitorsAll = [];
        return renderSection("visiteurs", visitorsAll);
      }

      const uniqIds = dedupeVisitors(rows)
        .filter(id => id !== myId && !isBlocked(id))
        .slice(0, 60);

      if (uniqIds.length === 0) {
        visitorsAll = [];
        return renderSection("visiteurs", visitorsAll);
      }

      const { data: profs, error: pErr } = await supabase
        .from("profiles")
        .select("id, username, gender, birthplace, photo, city_lat, city_lon")
        .in("id", uniqIds);

      if (pErr) {
        console.error("loadVisitors profiles:", pErr);
        visitorsAll = [];
        return renderSection("visiteurs", visitorsAll);
      }

      // garder l‚Äôordre des ids (le plus r√©cent en premier)
      const map = new Map((profs || []).map(p => [p.id, p]));
      visitorsAll = uniqIds.map(id => map.get(id)).filter(Boolean);

      await renderSection("visiteurs", visitorsAll);
    }

    // =========================================================
    // Enregistrer visite + ouvrir profil
    // =========================================================
    window.openProfile = async function(id) {
      if (id !== myId) {
        await supabase.from("visits").insert({
          visitor_id: myId,
          visited_id: id
        });
      }
      window.location.href = "profil.html?user=" + encodeURIComponent(id);
    };

    // =========================================================
    // Online status
    // =========================================================
    async function updateOnlineStatus() {
      await supabase.from("online_users").upsert({
        user_id: myId,
        last_seen: new Date().toISOString()
      }, { onConflict: "user_id" });
    }
    setInterval(updateOnlineStatus, 20000);

    // =========================================================
    // Boutons ‚ÄúAfficher plus‚Äù
    // =========================================================
    $("suggestions-more").addEventListener("click", () => toggleMore("suggestions"));
    $("en-ligne-more").addEventListener("click", () => toggleMore("en-ligne"));
    $("visiteurs-more").addEventListener("click", () => toggleMore("visiteurs"));

    // =========================================================
    // Logout
    // =========================================================
    $("logout").onclick = async (e) => {
      e.preventDefault();
      await supabase.auth.signOut();
      window.location.replace("index.html");
    };

    // =========================================================
    // INIT
    // =========================================================
    await updateOnlineStatus();
    await loadMyProfile();
    await loadBlockedIds();

    await loadSuggestions();
    await loadOnline();
    await loadVisitors();

    // refresh l√©ger
    setInterval(loadOnline, 30000);
    setInterval(loadSuggestions, 60000);
    setInterval(loadVisitors, 60000);
  </script>

</body>
</html>
