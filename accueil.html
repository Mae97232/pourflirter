<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Accueil - Pourflirter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="Design/accueil.css">
</head>

<body>

<header class="header">
  <div class="logo">üíô Pourflirter</div>
  <div class="search-bar">
    <input type="text" placeholder="Recherche...">
  </div>
  <nav class="nav-links">
    <a href="#">Messages</a>
    <a href="#">Cr√©dits (50)</a>
    <a href="#" id="logout">D√©connexion</a>
  </nav>
</header>

<div class="layout">

  <!-- SIDEBAR GAUCHE : PROFIL CONNECT√â -->
  <aside class="sidebar-left" id="user-profile"></aside>

  <!-- CONTENU PRINCIPAL -->
  <main class="main-content">

    <section class="profile-section">
      <h2 class="section-title">Suggestions</h2>
      <div class="profiles-grid" id="suggestions"></div>
    </section>

    <section class="profile-section">
      <h2 class="section-title">En ligne</h2>
      <div class="profiles-grid" id="en-ligne"></div>
    </section>

    <section class="profile-section">
      <h2 class="section-title">Derniers visiteurs</h2>
      <div class="profiles-grid" id="visiteurs"></div>
    </section>

  </main>

  <!-- SIDEBAR DROITE -->
  <aside class="sidebar-right">
    <a href="mes-photos.html">Mes Photos</a>
    <a href="profil.html">Mon Profil</a>
    <a href="mes-favoris.html">Mes Favoris</a>
    <a href="membres_bloques.html">Membres Bloqu√©s</a>
    <a href="achat_credits.html">Acheter Cr√©dits</a>
  </aside>

</div>

<footer class="footer">
  <a href="#">Service Clients</a>
  <a href="#">CGV</a>
  <a href="#">Protection des donn√©es</a>
  <a href="#">Mentions l√©gales</a>
  <a href="#">EN / FR</a>
  <div>¬© 2025 Pourflirter. Tous droits r√©serv√©s.</div>
</footer>

<!-- ================= SCRIPT ================= -->
<script type="module">
import { supabase } from "./supabaseClient.js";

/* ================= AUTH ================= */
const { data: { session } } = await supabase.auth.getSession();
if (!session) {
  window.location.replace("index.html");
}
const myId = session.user.id;

/* ================= PROFIL CONNECT√â ================= */
async function loadMyProfile() {
  const { data: user, error } = await supabase
    .from("profiles")
    .select("id, username, gender, birthplace, photo, adhesion, adeptes, contacts")
    .eq("id", myId)
    .single();

  if (error || !user) {
    document.getElementById("user-profile").innerHTML =
      `<div class="profile-card"><p>Profil introuvable</p></div>`;
    return;
  }

  document.getElementById("user-profile").innerHTML = `
    <div class="profile-card">
      <img src="${user.photo || 'default.jpg'}">
      <h3 class="username">${user.username}</h3>
      <p class="info">${user.gender || ''}</p>
      <button class="certif-btn">Faites vous certifier !</button>
      <p class="localisation">(${user.birthplace || ''})</p>
      <div class="stats">
        <div><strong>${user.adhesion ?? 0}</strong><br>Adh√©sion</div>
        <div><strong>${user.adeptes ?? 0}</strong><br>Adeptes</div>
        <div><strong>${user.contacts ?? 0}</strong><br>Contacts</div>
      </div>
    </div>
  `;
}

/* ================= CARTES PROFILS ================= */
function afficherCartes(containerId, profiles) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";

  (profiles || []).forEach(p => {
    if (!p) return;
    container.innerHTML += `
      <div class="profile-card" data-id="${p.id}">
        <img src="${p.photo || 'default.jpg'}">
        <div class="profile-info">
          <span class="username">${p.username}</span>
          <span class="details">${p.gender || ''} (${p.birthplace || ''})</span>
        </div>
      </div>
    `;
  });

  container.querySelectorAll(".profile-card").forEach(card => {
    card.onclick = () => openProfile(card.dataset.id);
  });
}

/* ================= OUVRIR PROFIL ================= */
async function openProfile(id) {
  if (id !== myId) {
    await supabase.from("visits").insert({
      visitor_id: myId,
      visited_id: id
    });
  }
  window.location.href = "profil.html?user=" + id;
}

/* ================= SUGGESTIONS ================= */
async function loadSuggestions() {
  const { data } = await supabase
    .from("profiles")
    .select("id, username, gender, birthplace, photo")
    .neq("id", myId)
    .limit(6);

  afficherCartes("suggestions", data);
}

/* ================= EN LIGNE ================= */
async function loadOnline() {
  const { data } = await supabase
    .from("online_users")
    .select("user_id, profiles(id, username, gender, birthplace, photo)")
    .gte("last_seen", new Date(Date.now() - 3 * 60 * 1000).toISOString());

  const profiles = (data || []).map(x => x.profiles).filter(Boolean);
  afficherCartes("en-ligne", profiles);
}

/* ================= VISITEURS ================= */
async function loadVisitors() {
  const { data } = await supabase
    .from("visits")
    .select("visitor_id, profiles(id, username, gender, birthplace, photo)")
    .eq("visited_id", myId)
    .order("created_at", { ascending: false })
    .limit(10);

  const profiles = (data || []).map(v => v.profiles).filter(Boolean);
  afficherCartes("visiteurs", profiles);
}

/* ================= ONLINE STATUS ================= */
async function updateOnlineStatus() {
  await supabase.from("online_users").upsert({
    user_id: myId,
    last_seen: new Date().toISOString()
  });
}
setInterval(updateOnlineStatus, 20000);

/* ================= LOGOUT ================= */
document.getElementById("logout").onclick = async (e) => {
  e.preventDefault();
  await supabase.auth.signOut();
  window.location.replace("index.html");
};

/* ================= LANCEMENT ================= */
await updateOnlineStatus();
await loadMyProfile();
await loadSuggestions();
await loadOnline();
await loadVisitors();
</script>

</body>
</html>
