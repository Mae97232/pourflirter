<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Accueil - Pourflirter</title>
  <link rel="stylesheet" href="Design/accueil.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<header class="header">
  <div class="logo">üíô Pourflirter</div>
  <div class="search-bar"><input type="text" placeholder="Recherche..."></div>
  <nav class="nav-links">
    <a href="message.html">Messages</a>
    <a href="#">Cr√©dits (50)</a>
    <a href="#" id="logout">D√©connexion</a>
  </nav>
</header>

<div class="layout">
  <!-- Profil utilisateur connect√© -->
  <aside class="sidebar-left" id="user-profile"></aside>

  <!-- Contenu principal -->
  <main class="main-content">

    <!-- Suggestions -->
    <section class="profile-section">
      <h2 class="section-title">Suggestions</h2>
      <div class="profiles-row" id="suggestions"></div>
      <button class="show-more" id="more-suggestions" type="button" style="display:none;">Afficher plus</button>
    </section>

    <!-- En ligne -->
    <section class="profile-section">
      <h2 class="section-title">En ligne</h2>
      <div class="profiles-row" id="en-ligne"></div>
      <button class="show-more" id="more-online" type="button" style="display:none;">Afficher plus</button>
    </section>

    <!-- Derniers visiteurs -->
    <section class="profile-section">
      <h2 class="section-title">Derniers visiteurs</h2>
      <div class="profiles-row" id="visiteurs"></div>
      <button class="show-more" id="more-visitors" type="button" style="display:none;">Afficher plus</button>
    </section>

  </main>

  <!-- Sidebar droite -->
  <aside class="sidebar-right">
    <a href="mes-photos.html">Mes Photos</a>
    <a href="profil.html">Mon Profil</a>
    <a href="mes-favoris.html">Mes Favoris</a>
    <a href="membres_bloques.html">Membres Bloqu√©s</a>
    <a href="achat_credits.html">Acheter Cr√©dits</a>
    <a href="parametre.html">Param√®tres</a>
  </aside>
</div>

<footer class="footer">
  <a href="#">Service Clients</a>
  <a href="#">CGV</a>
  <a href="#">Protection des donn√©es</a>
  <a href="#">Mentions l√©gales</a>
  <a href="#">EN / FR</a>
  <div>¬© 2025 Pourflirter. Tous droits r√©serv√©s.</div>
</footer>

<script type="module">
import { supabase } from "./supabaseClient.js";

const { data: { session } } = await supabase.auth.getSession();
if (!session) window.location.replace("index.html");
const myId = session.user.id;

/* ---------------- SIGNED URL photo profil ---------------- */
async function getProfilePhotoUrl(photoValue) {
  if (!photoValue) return "default.jpg";
  if (typeof photoValue === "string" && photoValue.startsWith("http")) {
    return photoValue + (photoValue.includes("?") ? "&" : "?") + "t=" + Date.now();
  }
  const { data, error } = await supabase.storage.from("profile_photos").createSignedUrl(photoValue, 60 * 60);
  if (error) return "default.jpg";
  return data.signedUrl + (data.signedUrl.includes("?") ? "&" : "?") + "t=" + Date.now();
}

/* ---------------- Distance (Haversine) ---------------- */
function distanceKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const toRad = (v) => (v * Math.PI) / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

/* ---------------- Helpers filtres ---------------- */
let myProfile = null;
let blockedSet = new Set();

function normalizeGender(v){
  return String(v || "").trim().toLowerCase();
}

function matchesLookingFor(profile){
  const lf = normalizeGender(myProfile?.lookingFor);
  if (!lf || lf === "non renseign√©") return true;
  if (lf === "les deux") return true;
  // lf = "homme" ou "femme"
  return normalizeGender(profile.gender) === lf;
}

function withinMyRadius(p){
  const myLat = myProfile?.lat;
  const myLng = myProfile?.lng;
  const r = Number(myProfile?.search_radius ?? 20);

  if (!Number.isFinite(myLat) || !Number.isFinite(myLng)) return true;
  if (!Number.isFinite(p.lat) || !Number.isFinite(p.lng)) return false;

  return distanceKm(myLat, myLng, p.lat, p.lng) <= r;
}

function isBlocked(p){
  return blockedSet.has(p.id);
}

/* ---------------- Bloqu√©s (dans les 2 sens) ----------------
   Table suppos√©e: blocked_users(blocker_id uuid, blocked_id uuid)
*/
async function loadBlocked() {
  blockedSet = new Set();

  const { data: a } = await supabase
    .from("blocked_users")
    .select("blocked_id")
    .eq("blocker_id", myId);

  (a || []).forEach(x => blockedSet.add(x.blocked_id));

  const { data: b } = await supabase
    .from("blocked_users")
    .select("blocker_id")
    .eq("blocked_id", myId);

  (b || []).forEach(x => blockedSet.add(x.blocker_id));
}

/* ---------------- Mon profil √† gauche ---------------- */
async function loadMyProfile() {
  const { data: user, error } = await supabase
    .from("profiles")
    .select("id, username, gender, birthplace, adhesion, adeptes, contacts, photo, lat, lng, search_radius, lookingFor")
    .eq("id", myId)
    .maybeSingle();

  if (error || !user) return;

  myProfile = user;

  const photoUrl = await getProfilePhotoUrl(user.photo);

  document.getElementById("user-profile").innerHTML = `
    <div class="profile-card">
      <img src="${photoUrl}" alt="Photo de profil">
      <h3 class="username">${user.username || ""}</h3>
      <p class="info">${user.gender || "Non renseign√©"}</p>
      <button class="certif-btn">Faites vous certifier !</button>
      <p class="localisation">(${user.birthplace || "Inconnu"})</p>

      <div class="stats">
        <div style="cursor:pointer" onclick="openList('adhesion')"><strong>${user.adhesion ?? 0}</strong><br>Adh√©sion</div>
        <div style="cursor:pointer" onclick="openList('adeptes')"><strong>${user.adeptes ?? 0}</strong><br>Adeptes</div>
        <div style="cursor:pointer" onclick="openList('contacts')"><strong>${user.contacts ?? 0}</strong><br>Contacts</div>
      </div>
    </div>
  `;
}

/* ---------------- UI: cartes (4 max) + afficher plus ---------------- */
async function renderRow(containerId, list, max4 = true) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";

  const take = max4 ? (list || []).slice(0, 4) : (list || []);
  const myLat = myProfile?.lat, myLng = myProfile?.lng;

  const cards = await Promise.all(take.map(async (p) => {
    const photoUrl = await getProfilePhotoUrl(p.photo);

    let distTxt = "";
    if (Number.isFinite(myLat) && Number.isFinite(myLng) && Number.isFinite(p.lat) && Number.isFinite(p.lng)) {
      distTxt = ` ‚Ä¢ ${Math.round(distanceKm(myLat, myLng, p.lat, p.lng))} km`;
    }

    return `
      <div class="mini-card" onclick="openProfile('${p.id}')">
        <img src="${photoUrl}" alt="">
        <div class="mini-info">
          <div class="mini-username">${p.username || ""}${distTxt}</div>
          <div class="mini-details">${p.gender || ""} (${p.birthplace || ""})</div>
        </div>
      </div>
    `;
  }));

  container.innerHTML = cards.join("");
}

/* ---------------- Open profile + visite ---------------- */
window.openProfile = async function(id){
  if (id !== myId) {
    await supabase.from("visits").insert({ visitor_id: myId, visited_id: id });
  }
  window.location.href = "profil.html?user=" + id;
};

/* ---------------- (Option) ouvre une page liste ---------------- */
window.openList = function(type){
  // tu peux cr√©er plus tard une page : list.html?type=adeptes / adhesion / contacts
  // pour l'instant, simple redirection (tu peux changer)
  window.location.href = "list.html?type=" + encodeURIComponent(type);
};

/* ---------------- ONLINE STATUS ---------------- */
async function updateOnlineStatus() {
  await supabase.from("online_users").upsert({
    user_id: myId,
    last_seen: new Date().toISOString()
  });
}
setInterval(updateOnlineStatus, 20000);

/* ---------------- DATA LOADERS ---------------- */
let cacheSuggestions = [];
let cacheOnline = [];
let cacheVisitors = [];

async function loadSuggestions() {
  const { data, error } = await supabase
    .from("profiles")
    .select("id, username, gender, birthplace, photo, lat, lng")
    .neq("id", myId)
    .limit(60);

  if (error) return;

  cacheSuggestions = (data || [])
    .filter(p => !isBlocked(p))
    .filter(matchesLookingFor)
    .filter(withinMyRadius);

  await renderRow("suggestions", cacheSuggestions, true);

  const btn = document.getElementById("more-suggestions");
  btn.style.display = cacheSuggestions.length > 4 ? "inline-block" : "none";
}

async function loadOnline() {
  // online_users doit exister et √™tre maintenu
  const { data, error } = await supabase
    .from("online_users")
    .select("user_id, last_seen, profiles(id, username, gender, birthplace, photo, lat, lng)")
    .gte("last_seen", new Date(Date.now() - 3 * 60 * 1000).toISOString());

  if (error) return;

  cacheOnline = (data || [])
    .map(x => x.profiles)
    .filter(Boolean)
    .filter(p => p.id !== myId)
    .filter(p => !isBlocked(p))
    .filter(matchesLookingFor)
    .filter(withinMyRadius);

  await renderRow("en-ligne", cacheOnline, true);

  const btn = document.getElementById("more-online");
  btn.style.display = cacheOnline.length > 4 ? "inline-block" : "none";
}

/* Derniers visiteurs style "wyylde" : d√©dupliqu√© par visitor_id */
async function loadVisitors() {
  const { data, error } = await supabase
    .from("visits")
    .select("visitor_id, created_at, profiles(id, username, gender, birthplace, photo, lat, lng)")
    .eq("visited_id", myId)
    .order("created_at", { ascending: false })
    .limit(80);

  if (error) return;

  const seen = new Set();
  const dedup = [];
  for (const v of (data || [])) {
    const p = v.profiles;
    if (!p) continue;
    if (seen.has(v.visitor_id)) continue; // ‚úÖ une seule fois
    seen.add(v.visitor_id);

    if (p.id === myId) continue;
    if (isBlocked(p)) continue;
    // visiteurs : tu peux choisir de filtrer OU PAS par rayon/lookingFor
    // moi je respecte les 2 comme tu as demand√© "filtre selon lookingFor"
    if (!matchesLookingFor(p)) continue;
    if (!withinMyRadius(p)) continue;

    dedup.push(p);
  }

  cacheVisitors = dedup;

  await renderRow("visiteurs", cacheVisitors, true);

  const btn = document.getElementById("more-visitors");
  btn.style.display = cacheVisitors.length > 4 ? "inline-block" : "none";
}

/* ---------------- Boutons Afficher plus ---------------- */
document.getElementById("more-suggestions").onclick = async () => {
  await renderRow("suggestions", cacheSuggestions, false);
  document.getElementById("more-suggestions").style.display = "none";
};

document.getElementById("more-online").onclick = async () => {
  await renderRow("en-ligne", cacheOnline, false);
  document.getElementById("more-online").style.display = "none";
};

document.getElementById("more-visitors").onclick = async () => {
  await renderRow("visiteurs", cacheVisitors, false);
  document.getElementById("more-visitors").style.display = "none";
};

/* ---------------- Logout ---------------- */
document.getElementById("logout").onclick = async (e) => {
  e.preventDefault();
  await supabase.auth.signOut();
  window.location.replace("index.html");
};

/* ---------------- INIT ---------------- */
await updateOnlineStatus();
await loadBlocked();
await loadMyProfile();
await loadSuggestions();
await loadOnline();
await loadVisitors();
</script>

</body>
</html>
