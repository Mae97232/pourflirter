<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mon Profil ‚Äì Pourflirter</title>
  <link rel="icon" href="Image/favicon.ico.jpg" />
  <link rel="stylesheet" href="Design/profil-style.css">
</head>
<body>

<header class="header">
  <div class="logo">üíô <a href="accueil.html" style="color:inherit;text-decoration:none">Pourflirter</a></div>
  <div class="search-bar">
    <input type="text" placeholder="Recherche..."><button>üîç</button>
  </div>
  <nav class="nav-links">
    <a href="message.html">Messages</a>
    <a href="#">Cr√©dits (50)</a>
    <a href="#" id="logout">D√©connexion</a>
  </nav>
</header>

<div class="layout">

  <div class="main-content">

    <!-- PHOTOS -->
    <section class="section">
      <h3 class="section-title">Mes photos</h3>
      <div id="photo-grid" class="photo-grid"></div>

      <div style="margin-top:10px;">
        <a href="mes-photos.html" style="text-decoration:underline;">G√©rer mes photos</a>
      </div>
    </section>

    <!-- PROFIL -->
    <section class="section">
      <h2 id="user-name" class="section-title"></h2>

      <div class="profile-photo-wrapper">
        <label id="photo-label">
          <img id="profile-photo" src="default.jpg" alt="Photo de profil">
          <div class="photo-overlay">Changer la photo</div>
        </label>
        <input type="file" id="profile-photo-upload" accept="image/*" hidden>
      </div>

      <ul class="infos-profil">
        <li><strong>√Çge :</strong> <span id="age"></span></li>
        <li><strong>Signe :</strong> <span id="zodiac-sign"></span></li>
        <li><strong>Sexe :</strong> <span id="gender"></span></li>
        <li><strong>Ville :</strong> <span id="birthplace"></span></li>
        <li><strong>Recherche :</strong> <span id="lookingFor"></span></li>
        <li><strong>Rayon :</strong>
          <select id="radius-select">
            <option value="5">5 km</option>
            <option value="10">10 km</option>
            <option value="20">20 km</option>
            <option value="50">50 km</option>
            <option value="100">100 km</option>
          </select>
        </li>
      </ul>

      <div id="message-button-container"></div>
    </section>

  </div>

  <aside class="sidebar-right">
    <a href="mes-photos.html">Mes Photos</a>
    <a href="profil.html" class="active">Mon Profil</a>
    <a href="mes-favoris.html">Mes Favoris</a>
    <a href="membres_bloques.html">Membres Bloqu√©s</a>
    <a href="achat_credits.html">Acheter Cr√©dits</a>
  </aside>

</div>

<footer class="footer">
  <a href="#">CGV</a> | <a href="#">Protection des donn√©es</a> | <a href="#">Mentions l√©gales</a>
</footer>

<!-- ================= SUPABASE ================= -->
<script type="module">
import { supabase } from "./supabaseClient.js";

/* --------- HELPERS --------- */
function getAge(d){
  const bd = new Date(d);
  if (Number.isNaN(bd.getTime())) return "";
  const today = new Date();
  let age = today.getFullYear() - bd.getFullYear();
  const m = today.getMonth() - bd.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < bd.getDate())) age--;
  return age;
}
function getZodiac(d){
  const dt = new Date(d);
  if (Number.isNaN(dt.getTime())) return "";
  const m=dt.getMonth()+1, day=dt.getDate();
  return (m==3&&day>=21)||(m==4&&day<=19)?"B√©lier":
         (m==4&&day>=20)||(m==5&&day<=20)?"Taureau":
         (m==5&&day>=21)||(m==6&&day<=20)?"G√©meaux":
         (m==6&&day>=21)||(m==7&&day<=22)?"Cancer":
         (m==7&&day>=23)||(m==8&&day<=22)?"Lion":
         (m==8&&day>=23)||(m==9&&day<=22)?"Vierge":
         (m==9&&day>=23)||(m==10&&day<=22)?"Balance":
         (m==10&&day>=23)||(m==11&&day<=21)?"Scorpion":
         (m==11&&day>=22)||(m==12&&day<=21)?"Sagittaire":
         (m==12&&day>=22)||(m==1&&day<=19)?"Capricorne":
         (m==1&&day>=20)||(m==2&&day<=18)?"Verseau":"Poissons";
}
function setText(id, value) {
  const el = document.getElementById(id);
  if (el) el.textContent = value ?? "";
}

/* --------- AUTH --------- */
const { data: { session } } = await supabase.auth.getSession();
if (!session) window.location.replace("index.html");

const myId = session.user.id;
const viewedId = new URLSearchParams(location.search).get("user") || myId;
const isOwner = (myId === viewedId);

/* --------- SIGNED URL (profile_photos bucket priv√©) --------- */
async function getProfilePhotoUrl(photoValue) {
  if (!photoValue) return "default.jpg";

  // compat anciennes valeurs URL
  if (typeof photoValue === "string" && photoValue.startsWith("http")) {
    return photoValue + (photoValue.includes("?") ? "&" : "?") + "t=" + Date.now();
  }

  const { data, error } = await supabase.storage
    .from("profile_photos")
    .createSignedUrl(photoValue, 60 * 60);

  if (error) {
    console.error("SignedUrl photo profil:", error);
    return "default.jpg";
  }

  return data.signedUrl + (data.signedUrl.includes("?") ? "&" : "?") + "t=" + Date.now();
}

/* --------- SIGNED URL (user_photos bucket priv√©) --------- */
async function getUserPhotoUrl(path) {
  const { data, error } = await supabase.storage
    .from("user_photos")
    .createSignedUrl(path, 60 * 60);

  if (error) {
    console.error("SignedUrl user photo:", error);
    return null;
  }

  return data.signedUrl + (data.signedUrl.includes("?") ? "&" : "?") + "t=" + Date.now();
}

/* --------- PROFIL --------- */
async function loadProfile() {
  const { data: user, error } = await supabase
    .from("profiles")
    .select("id, username, birthdate, birthplace, gender, lookingFor, search_radius, photo")
    .eq("id", viewedId)
    .single();

  if (error) {
    console.error("Erreur SELECT profiles:", error);
    alert("‚ùå Profil introuvable ou acc√®s refus√© (RLS) : " + error.message);
    return;
  }
  if (!user) {
    alert("‚ùå Aucun profil trouv√© pour cet utilisateur.");
    return;
  }

  document.getElementById("user-name").textContent = user.username || "";
  document.getElementById("profile-photo").src = await getProfilePhotoUrl(user.photo);

  setText("age", user.birthdate ? (getAge(user.birthdate) + " ans") : "");
  setText("zodiac-sign", user.birthdate ? getZodiac(user.birthdate) : "");
  setText("gender", user.gender || "");
  setText("birthplace", user.birthplace || "");
  setText("lookingFor", user.lookingFor || "");

  const radiusEl = document.getElementById("radius-select");
  radiusEl.value = String(user.search_radius ?? 20);

  if (!isOwner) {
    radiusEl.disabled = true;
    const overlay = document.querySelector(".photo-overlay");
    if (overlay) overlay.style.display = "none";
  }

  await loadGallery();
}

/* --------- GALERIE (LECTURE SEULE, bucket priv√© OK) --------- */
async function loadGallery() {
  const { data: files, error } = await supabase.storage
    .from("user_photos")
    .list(viewedId + "/", { limit: 200, sortBy: { column: "name", order: "desc" } });

  if (error) console.error("Erreur storage list:", error);

  const grid = document.getElementById("photo-grid");
  grid.innerHTML = "";

  if (!files || files.length === 0) return;

  const items = await Promise.all(
    files.map(async (f) => {
      const path = `${viewedId}/${f.name}`;
      const url = await getUserPhotoUrl(path);
      return url;
    })
  );

  items.filter(Boolean).forEach(url => {
    grid.innerHTML += `<div class="photo-slot"><img src="${url}" alt=""></div>`;
  });
}

/* --------- PHOTO PROFIL (seulement propri√©taire) --------- */
if (isOwner) {
  document.getElementById("photo-label").onclick = () =>
    document.getElementById("profile-photo-upload").click();

  document.getElementById("profile-photo-upload").onchange = async e => {
    const file = e.target.files[0];
    if (!file) return;

    const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
    const path = `${myId}/profile.${ext}`;

    const { error: upErr } = await supabase.storage
      .from("profile_photos")
      .upload(path, file, { upsert: true });

    if (upErr) {
      alert("‚ùå Upload photo profil : " + upErr.message);
      return;
    }

    const { error: dbErr } = await supabase
      .from("profiles")
      .update({ photo: path })
      .eq("id", myId);

    if (dbErr) {
      alert("‚ùå Update DB photo : " + dbErr.message);
      return;
    }

    document.getElementById("profile-photo").src = await getProfilePhotoUrl(path);
  };
}

/* --------- RAYON --------- */
document.getElementById("radius-select").onchange = async (e) => {
  if (!isOwner) return;

  const val = Number(e.target.value);
  const { error } = await supabase
    .from("profiles")
    .update({ search_radius: val })
    .eq("id", myId);

  if (error) alert("‚ùå Erreur rayon : " + error.message);
};

/* --------- LOGOUT --------- */
document.getElementById("logout").onclick = async (e) => {
  e.preventDefault();
  await supabase.auth.signOut();
  window.location.replace("index.html");
};

loadProfile();
</script>

</body>
</html>


