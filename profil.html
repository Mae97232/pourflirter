<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mon Profil ‚Äì Pourflirter</title>
  <link rel="icon" href="Image/favicon.ico.jpg" />
  <link rel="stylesheet" href="Design/profil-style.css">
</head>
<body>

<header class="header">
  <div class="logo">üíô <a href="accueil.html" style="color:inherit;text-decoration:none">Pourflirter</a></div>
  <div class="search-bar">
    <input type="text" placeholder="Recherche..."><button>üîç</button>
  </div>
  <nav class="nav-links">
    <a href="message.html">Messages</a>
    <a href="#">Cr√©dits (50)</a>
    <a href="#" id="logout">D√©connexion</a>
  </nav>
</header>

<div class="layout">

  <div class="main-content">

    <!-- PHOTOS -->
    <section class="section">
      <h3 class="section-title">Mes photos</h3>
      <div id="photo-grid" class="photo-grid"></div>

      <div style="margin-top:10px;">
        <a href="mes-photos.html" style="text-decoration:underline;">G√©rer mes photos</a>
      </div>
    </section>

    <!-- PROFIL -->
    <section class="section">
      <h2 id="user-name" class="section-title"></h2>

      <div class="profile-photo-wrapper">
        <label id="photo-label">
          <img id="profile-photo" src="default.jpg" alt="Photo de profil">
          <div class="photo-overlay">Changer la photo</div>
        </label>
        <input type="file" id="profile-photo-upload" accept="image/*" hidden>
      </div>

      <ul class="infos-profil">
        <li><strong>√Çge :</strong> <span id="age"></span></li>
        <li><strong>Signe :</strong> <span id="zodiac-sign"></span></li>
        <li><strong>Sexe :</strong> <span id="gender"></span></li>
        <li><strong>Ville :</strong> <span id="birthplace"></span></li>
        <li><strong>Recherche :</strong> <span id="lookingFor"></span></li>
        <li><strong>Rayon :</strong>
          <select id="radius-select">
            <option value="5">5 km</option>
            <option value="10">10 km</option>
            <option value="20">20 km</option>
            <option value="50">50 km</option>
            <option value="100">100 km</option>
          </select>
        </li>
      </ul>

      <!-- ‚úÖ ICI on affichera les boutons quand on regarde un autre profil -->
      <div id="message-button-container"></div>

      <!-- ‚úÖ petit statut -->
      <div id="action-status" style="margin-top:10px;"></div>
    </section>

  </div>

  <aside class="sidebar-right">
    <a href="mes-photos.html">Mes Photos</a>
    <a href="profil.html" class="active">Mon Profil</a>
    <a href="mes-favoris.html">Mes Favoris</a>
    <a href="membres_bloques.html">Membres Bloqu√©s</a>
    <a href="achat_credits.html">Acheter Cr√©dits</a>
    <a href="parametre.html">Param√®tres</a>
  </aside>

</div>

<footer class="footer">
  <a href="#">CGV</a> | <a href="#">Protection des donn√©es</a> | <a href="#">Mentions l√©gales</a>
</footer>

<script type="module">
import { supabase } from "./supabaseClient.js";

/* --------- HELPERS --------- */
function getAge(d){
  const bd = new Date(d);
  if (Number.isNaN(bd.getTime())) return "";
  const today = new Date();
  let age = today.getFullYear() - bd.getFullYear();
  const m = today.getMonth() - bd.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < bd.getDate())) age--;
  return age;
}
function getZodiac(d){
  const dt = new Date(d);
  if (Number.isNaN(dt.getTime())) return "";
  const m=dt.getMonth()+1, day=dt.getDate();
  return (m==3&&day>=21)||(m==4&&day<=19)?"B√©lier":
         (m==4&&day>=20)||(m==5&&day<=20)?"Taureau":
         (m==5&&day>=21)||(m==6&&day<=20)?"G√©meaux":
         (m==6&&day>=21)||(m==7&&day<=22)?"Cancer":
         (m==7&&day>=23)||(m==8&&day<=22)?"Lion":
         (m==8&&day>=23)||(m==9&&day<=22)?"Vierge":
         (m==9&&day>=23)||(m==10&&day<=22)?"Balance":
         (m==10&&day>=23)||(m==11&&day<=21)?"Scorpion":
         (m==11&&day>=22)||(m==12&&day<=21)?"Sagittaire":
         (m==12&&day>=22)||(m==1&&day<=19)?"Capricorne":
         (m==1&&day>=20)||(m==2&&day<=18)?"Verseau":"Poissons";
}
function setText(id, value) {
  const el = document.getElementById(id);
  if (el) el.textContent = value ?? "";
}
function setStatus(msg, ok=true){
  const el = document.getElementById("action-status");
  if (!el) return;
  el.textContent = msg || "";
  el.style.color = ok ? "#1a7f37" : "#c62828";
}

/* --------- AUTH --------- */
const { data: { session } } = await supabase.auth.getSession();
if (!session) window.location.replace("index.html");

const myId = session.user.id;
const viewedId = new URLSearchParams(location.search).get("user") || myId;
const isOwner = (myId === viewedId);

/* ‚úÖ assure que TON profil existe */
await supabase.from("profiles").upsert({ id: myId }, { onConflict: "id" });

/* --------- SIGNED URL (profile_photos bucket priv√©) --------- */
async function getProfilePhotoUrl(photoValue) {
  if (!photoValue) return "default.jpg";
  if (typeof photoValue === "string" && photoValue.startsWith("http")) {
    return photoValue + (photoValue.includes("?") ? "&" : "?") + "t=" + Date.now();
  }

  const { data, error } = await supabase.storage
    .from("profile_photos")
    .createSignedUrl(photoValue, 60 * 60);

  if (error) {
    console.error("SignedUrl photo profil:", error);
    return "default.jpg";
  }

  return data.signedUrl + (data.signedUrl.includes("?") ? "&" : "?") + "t=" + Date.now();
}

/* --------- SIGNED URL (user_photos bucket priv√©) --------- */
async function getUserPhotoUrl(path) {
  const { data, error } = await supabase.storage
    .from("user_photos")
    .createSignedUrl(path, 60 * 60);

  if (error) {
    console.error("SignedUrl user photo:", error);
    return null;
  }

  return data.signedUrl + (data.signedUrl.includes("?") ? "&" : "?") + "t=" + Date.now();
}

/* ===========================================================
   ‚úÖ ACTIONS : follow / contact / message
   =========================================================== */
async function isFollowing() {
  const { data, error } = await supabase
    .from("follows")
    .select("follower_id")
    .eq("follower_id", myId)
    .eq("followed_id", viewedId)
    .maybeSingle();

  if (error) console.warn("isFollowing:", error.message);
  return !!data;
}

async function isInContacts() {
  const { data, error } = await supabase
    .from("contacts")
    .select("user_id")
    .eq("user_id", myId)
    .eq("contact_id", viewedId)
    .maybeSingle();

  if (error) console.warn("isInContacts:", error.message);
  return !!data;
}

/* ‚úÖ petit helper pour MAJ compteurs (simple, sans trigger) */
async function updateCountersAfterFollow(add) {
  // adhesion = je m'abonne (count following)
  // adeptes = il gagne/perd un abonn√©
  const { data: me } = await supabase.from("profiles").select("adhesion").eq("id", myId).maybeSingle();
  const { data: other } = await supabase.from("profiles").select("adeptes").eq("id", viewedId).maybeSingle();

  const myAdhesion = Number(me?.adhesion ?? 0);
  const otherAdeptes = Number(other?.adeptes ?? 0);

  const newMyAdhesion = Math.max(0, myAdhesion + (add ? 1 : -1));
  const newOtherAdeptes = Math.max(0, otherAdeptes + (add ? 1 : -1));

  await supabase.from("profiles").update({ adhesion: newMyAdhesion }).eq("id", myId);
  await supabase.from("profiles").update({ adeptes: newOtherAdeptes }).eq("id", viewedId);
}

async function updateCountersAfterContact(add) {
  // contacts = mon compteur contacts
  const { data: me } = await supabase.from("profiles").select("contacts").eq("id", myId).maybeSingle();
  const myContacts = Number(me?.contacts ?? 0);
  const newMyContacts = Math.max(0, myContacts + (add ? 1 : -1));
  await supabase.from("profiles").update({ contacts: newMyContacts }).eq("id", myId);
}

async function toggleFollow(btn) {
  setStatus("");
  const following = await isFollowing();

  if (!following) {
    const { error } = await supabase.from("follows").insert({
      follower_id: myId,
      followed_id: viewedId
    });
    if (error) return setStatus("‚ùå Erreur abonnement : " + error.message, false);

    await updateCountersAfterFollow(true);
    btn.textContent = "‚úÖ Abonn√©";
    btn.dataset.state = "on";
    setStatus("‚úÖ Tu es abonn√©(e) √† ce profil.");
  } else {
    const { error } = await supabase
      .from("follows")
      .delete()
      .eq("follower_id", myId)
      .eq("followed_id", viewedId);

    if (error) return setStatus("‚ùå Erreur d√©sabonnement : " + error.message, false);

    await updateCountersAfterFollow(false);
    btn.textContent = "S‚Äôabonner";
    btn.dataset.state = "off";
    setStatus("‚úÖ D√©sabonn√©(e).");
  }
}

async function toggleContact(btn) {
  setStatus("");
  const inContacts = await isInContacts();

  if (!inContacts) {
    const { error } = await supabase.from("contacts").insert({
      user_id: myId,
      contact_id: viewedId
    });
    if (error) return setStatus("‚ùå Erreur contact : " + error.message, false);

    await updateCountersAfterContact(true);
    btn.textContent = "‚úÖ Dans mes contacts";
    btn.dataset.state = "on";
    setStatus("‚úÖ Ajout√© aux contacts.");
  } else {
    const { error } = await supabase
      .from("contacts")
      .delete()
      .eq("user_id", myId)
      .eq("contact_id", viewedId);

    if (error) return setStatus("‚ùå Erreur suppression contact : " + error.message, false);

    await updateCountersAfterContact(false);
    btn.textContent = "Ajouter aux contacts";
    btn.dataset.state = "off";
    setStatus("‚úÖ Retir√© des contacts.");
  }
}

function openMessage() {
  // adapte si ton message.html fonctionne autrement
  window.location.href = "message.html?user=" + encodeURIComponent(viewedId);
}

async function renderActions() {
  const container = document.getElementById("message-button-container");
  if (!container) return;

  // Si propri√©taire => pas de boutons (tu peux en mettre d'autres ici)
  if (isOwner) {
    container.innerHTML = "";
    return;
  }

  // Check states
  const following = await isFollowing();
  const inContacts = await isInContacts();

  container.innerHTML = `
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
      <button id="btn-follow" type="button">
        ${following ? "‚úÖ Abonn√©" : "S‚Äôabonner"}
      </button>

      <button id="btn-contact" type="button">
        ${inContacts ? "‚úÖ Dans mes contacts" : "Ajouter aux contacts"}
      </button>

      <button id="btn-message" type="button">
        Envoyer un message
      </button>
    </div>
  `;

  const btnFollow = document.getElementById("btn-follow");
  const btnContact = document.getElementById("btn-contact");
  const btnMessage = document.getElementById("btn-message");

  btnFollow.onclick = () => toggleFollow(btnFollow);
  btnContact.onclick = () => toggleContact(btnContact);
  btnMessage.onclick = openMessage;
}

/* --------- PROFIL --------- */
async function loadProfile() {
  const { data: user, error } = await supabase
    .from("profiles")
    .select("id, username, birthdate, birthplace, gender, lookingFor, search_radius, photo")
    .eq("id", viewedId)
    .maybeSingle();

  if (error) {
    console.error("Erreur SELECT profiles:", error);
    alert("‚ùå Profil introuvable ou acc√®s refus√© (RLS) : " + error.message);
    return;
  }
  if (!user) {
    alert("‚ùå Aucun profil trouv√© pour cet utilisateur.");
    return;
  }

  document.getElementById("user-name").textContent = user.username || "";

  const photoEl = document.getElementById("profile-photo");
  photoEl.src = await getProfilePhotoUrl(user.photo);
  photoEl.onerror = () => { photoEl.src = "default.jpg"; };

  setText("age", user.birthdate ? (getAge(user.birthdate) + " ans") : "");
  setText("zodiac-sign", user.birthdate ? getZodiac(user.birthdate) : "");
  setText("gender", user.gender || "");
  setText("birthplace", user.birthplace || "");
  setText("lookingFor", user.lookingFor || "");

  const radiusEl = document.getElementById("radius-select");
  radiusEl.value = String(user.search_radius ?? 20);

  if (!isOwner) {
    radiusEl.disabled = true;
    const overlay = document.querySelector(".photo-overlay");
    if (overlay) overlay.style.display = "none";
  }

  await renderActions();
  await loadGallery();
}

/* --------- GALERIE (LECTURE SEULE, bucket priv√© OK) --------- */
async function loadGallery() {
  const { data: files, error } = await supabase.storage
    .from("user_photos")
    .list(viewedId + "/", { limit: 200, sortBy: { column: "name", order: "desc" } });

  if (error) console.error("Erreur storage list:", error);

  const grid = document.getElementById("photo-grid");
  grid.innerHTML = "";

  if (!files || files.length === 0) return;

  const items = await Promise.all(
    files.map(async (f) => {
      const path = `${viewedId}/${f.name}`;
      const url = await getUserPhotoUrl(path);
      return url;
    })
  );

  items.filter(Boolean).forEach(url => {
    grid.innerHTML += `<div class="photo-slot"><img src="${url}" alt=""></div>`;
  });
}

/* --------- PHOTO PROFIL (seulement propri√©taire) --------- */
if (isOwner) {
  document.getElementById("photo-label").onclick = () =>
    document.getElementById("profile-photo-upload").click();

  document.getElementById("profile-photo-upload").onchange = async e => {
    const file = e.target.files[0];
    if (!file) return;

    const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
    const path = `${myId}/profile.${ext}`;

    const { error: upErr } = await supabase.storage
      .from("profile_photos")
      .upload(path, file, { upsert: true });

    if (upErr) {
      alert("‚ùå Upload photo profil : " + upErr.message);
      return;
    }

    const { error: dbErr } = await supabase
      .from("profiles")
      .update({ photo: path })
      .eq("id", myId);

    if (dbErr) {
      alert("‚ùå Update DB photo : " + dbErr.message);
      return;
    }

    const img = document.getElementById("profile-photo");
    img.src = await getProfilePhotoUrl(path);
    img.onerror = () => { img.src = "default.jpg"; };
  };
}

/* --------- RAYON --------- */
document.getElementById("radius-select").onchange = async (e) => {
  if (!isOwner) return;

  const val = Number(e.target.value);
  const { error } = await supabase
    .from("profiles")
    .update({ search_radius: val })
    .eq("id", myId);

  if (error) alert("‚ùå Erreur rayon : " + error.message);
};

/* --------- LOGOUT --------- */
document.getElementById("logout").onclick = async (e) => {
  e.preventDefault();
  await supabase.auth.signOut();
  window.location.replace("index.html");
};

/* --------- INIT --------- */
loadProfile();
</script>

</body>
</html>
