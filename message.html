<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messages - Pourflirter</title>
  <link rel="stylesheet" href="Design/message.css">
</head>
<body>

<header class="header">
  <div class="logo">üíô <a href="accueil.html" style="text-decoration:none; color:inherit;"><span>Pourflirter</span></a></div>

  <div class="header-center">
    <div class="search-bar">
      <input type="text" placeholder="Recherche...">
      <button type="button">üîç</button>
    </div>
  </div>

  <div class="header-actions">
    <div class="header-links">
      <a href="message.html">Messages</a>
      <a href="achat_credits.html">Cr√©dits</a>
      <a href="#" id="logoutBtn">D√©connexion</a>
    </div>
    <div class="user-photo">
      <img src="images/utilisateur.jpg" alt="Ma photo" id="myAvatar">
    </div>
  </div>
</header>

<div class="layout">

  <!-- Liste des conversations (on la remplira plus tard si tu veux) -->
  <aside class="conversations-list">
    <h3>Discussions</h3>
    <div id="conversationsPlaceholder" style="padding:10px; opacity:.7;">
      (Liste des discussions √† brancher ensuite)
    </div>
  </aside>

  <!-- Zone de messagerie -->
  <main class="messagerie">

    <!-- En-t√™te de la conversation -->
    <div class="conversation-header">
      <div class="avatar">
        <img src="images/utilisateur.jpg" alt="Avatar" id="recipientAvatar">
      </div>
      <div class="pseudo">Discussion avec <strong id="recipientName">...</strong></div>
    </div>

    <!-- Liste messages -->
    <div id="messagesContainer" style="display:flex; flex-direction:column; gap:10px; padding:10px;">
      <!-- messages inject√©s ici -->
    </div>

    <!-- Formulaire d'envoi -->
    <form class="message-form" id="messageForm" autocomplete="off">
      <input id="messageInput" type="text" placeholder="√âcris ton message..." required>
      <button id="sendBtn" type="submit">Envoyer pour 5 cr√©dits</button>
    </form>

  </main>

  <!-- Barre lat√©rale √† droite -->
  <aside class="sidebar-right">
    <a href="mes-photos.html">Mes Photos</a>
    <a href="profil.html">Mon Profil</a>
    <a href="mes-favoris.html">Mes Favoris</a>
    <a href="membres_bloques.html">Membres Bloqu√©s</a>
    <a href="achat_credits.html">Acheter Cr√©dits</a>
    <a href="parametre.html">Param√®tres</a>
  </aside>

</div>

<footer class="footer">
  <a href="#">Service Clients</a>
  <a href="#">CGV</a>
  <a href="#">Protection des donn√©es</a>
  <a href="#">Mentions l√©gales</a>
  <a href="#">EN / FR</a>
  ¬© 2025 Pourflirter. Tous droits r√©serv√©s.
</footer>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  // ‚úÖ REMPLACE ICI
  const SUPABASE_URL = "TON_SUPABASE_URL";
  const SUPABASE_ANON_KEY = "TON_SUPABASE_ANON_KEY";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const recipientNameEl = document.getElementById("recipientName");
  const recipientAvatarEl = document.getElementById("recipientAvatar");
  const myAvatarEl = document.getElementById("myAvatar");
  const messagesContainer = document.getElementById("messagesContainer");
  const messageForm = document.getElementById("messageForm");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  let myUserId = null;
  let recipientId = null;
  let realtimeChannel = null;

  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  function escapeHtml(str) {
    return (str ?? "").replace(/[&<>"']/g, (m) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#039;"
    }[m]));
  }

  function scrollToBottom() {
    // petit timeout pour laisser le DOM se mettre √† jour
    setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" }), 50);
  }

  function renderMessage({ content, created_at, sender_id }) {
    const isMine = sender_id === myUserId;

    const div = document.createElement("div");
    div.className = "message " + (isMine ? "sent" : "received");
    div.innerHTML = `
      ${escapeHtml(content)}
      <time>${new Date(created_at).toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" })}</time>
    `;
    messagesContainer.appendChild(div);
  }

  function setUiRecipient(profile) {
    recipientNameEl.textContent = profile?.username || "Utilisateur";
    recipientAvatarEl.src = profile?.profile_photo || "images/utilisateur.jpg";
    recipientAvatarEl.alt = profile?.username || "Avatar";
  }

  function setUiMe(profile) {
    myAvatarEl.src = profile?.profile_photo || "images/utilisateur.jpg";
    myAvatarEl.alt = profile?.username || "Ma photo";
  }

  async function requireSession() {
    const { data, error } = await supabase.auth.getSession();
    if (error) {
      console.error(error);
      alert("Erreur session. Ouvre la console F12.");
      return null;
    }
    const session = data?.session;
    if (!session) {
      // Pas connect√© => redirige
      window.location.href = "connexion.html";
      return null;
    }
    return session;
  }

  async function loadMyProfile() {
    const { data, error } = await supabase
      .from("profiles")
      .select("id, username, profile_photo")
      .eq("id", myUserId)
      .single();

    if (error) {
      console.warn("Profil perso non trouv√© / RLS ?", error);
      // on ne bloque pas la page
      return null;
    }
    setUiMe(data);
    return data;
  }

  async function loadRecipientProfile() {
    const { data, error } = await supabase
      .from("profiles")
      .select("id, username, profile_photo")
      .eq("id", recipientId)
      .single();

    if (error || !data) {
      console.error("Destinataire introuvable:", error);
      alert("Utilisateur introuvable (profil inexistant ou acc√®s refus√©).");
      // tu peux rediriger si tu veux :
      // window.location.href = "accueil.html";
      return null;
    }

    setUiRecipient(data);
    return data;
  }

  async function loadMessages() {
    messagesContainer.innerHTML = "";

    // On charge les messages o√π (moi->lui) OU (lui->moi)
    const { data, error } = await supabase
      .from("messages")
      .select("id, sender_id, receiver_id, content, created_at")
      .or(
        `and(sender_id.eq.${myUserId},receiver_id.eq.${recipientId}),and(sender_id.eq.${recipientId},receiver_id.eq.${myUserId})`
      )
      .order("created_at", { ascending: true });

    if (error) {
      console.error("Erreur chargement messages:", error);
      alert("Impossible de charger les messages (RLS/table). Ouvre la console F12.");
      return;
    }

    for (const msg of (data || [])) renderMessage(msg);
    scrollToBottom();
  }

  async function sendMessage(text) {
    const payload = {
      sender_id: myUserId,
      receiver_id: recipientId,
      content: text
    };

    const { data, error } = await supabase
      .from("messages")
      .insert(payload)
      .select("id, sender_id, receiver_id, content, created_at")
      .single();

    if (error) {
      console.error("Erreur envoi:", error);
      alert("Envoi impossible (RLS/table). Ouvre la console F12.");
      return null;
    }

    return data;
  }

  async function subscribeRealtime() {
    // Important: n√©cessite que Realtime soit activ√© sur la table messages (Supabase dashboard)
    // On filtre sur les inserts et on affiche si √ßa concerne cette conversation
    realtimeChannel = supabase
      .channel("messages-realtime")
      .on(
        "postgres_changes",
        { event: "INSERT", schema: "public", table: "messages" },
        (payload) => {
          const msg = payload.new;
          const isThisConversation =
            (msg.sender_id === myUserId && msg.receiver_id === recipientId) ||
            (msg.sender_id === recipientId && msg.receiver_id === myUserId);

          if (!isThisConversation) return;

          // √âvite doublon: si c'est mon message, je l'affiche d√©j√† apr√®s insert
          // (si tu veux, tu peux garder et faire un check d'id)
          if (msg.sender_id === myUserId) return;

          renderMessage(msg);
          scrollToBottom();
        }
      )
      .subscribe((status) => {
        console.log("Realtime status:", status);
      });
  }

  async function init() {
    recipientId = getQueryParam("to");

    if (!recipientId) {
      alert("Lien invalide : il manque ?to=ID_DESTINATAIRE");
      return;
    }

    const session = await requireSession();
    if (!session) return;

    myUserId = session.user.id;

    // Profil moi + profil destinataire
    await loadMyProfile();
    const recipient = await loadRecipientProfile();
    if (!recipient) return;

    // Charger messages
    await loadMessages();

    // Realtime
    await subscribeRealtime();
  }

  messageForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text) return;

    sendBtn.disabled = true;

    const inserted = await sendMessage(text);
    if (inserted) {
      renderMessage(inserted);
      messageInput.value = "";
      scrollToBottom();
    }

    sendBtn.disabled = false;
    messageInput.focus();
  });

  logoutBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    await supabase.auth.signOut();
    window.location.href = "connexion.html";
  });

  window.addEventListener("beforeunload", async () => {
    try {
      if (realtimeChannel) await supabase.removeChannel(realtimeChannel);
    } catch {}
  });

  init();
</script>

</body>
</html>
