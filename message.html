<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messages - Pourflirter</title>
  <link rel="stylesheet" href="Design/message.css">
</head>
<body>

<header class="header">
  <div class="logo">üíô <a href="accueil.html" style="text-decoration:none; color:inherit;"><span>Pourflirter</span></a></div>

  <div class="header-center">
    <div class="search-bar">
      <input type="text" placeholder="Recherche...">
      <button type="button">üîç</button>
    </div>
  </div>

  <div class="header-actions">
    <div class="header-links">
      <a href="message.html">Messages</a>
      <a href="achat_credits.html">Cr√©dits</a>
      <a href="#" id="logoutBtn">D√©connexion</a>
    </div>
    <div class="user-photo">
      <img src="images/utilisateur.jpg" alt="Ma photo" id="myAvatar">
    </div>
  </div>
</header>

<div class="layout">

  <!-- Liste des conversations : on branchera apr√®s -->
  <aside class="conversations-list">
    <h3>Discussions</h3>
    <div style="padding:10px; opacity:.7;">(Liste des discussions √† brancher ensuite)</div>
  </aside>

  <main class="messagerie">

    <div class="conversation-header">
      <div class="avatar">
        <img src="images/utilisateur.jpg" alt="Avatar" id="recipientAvatar">
      </div>
      <div class="pseudo">Discussion avec <strong id="recipientName">...</strong></div>
    </div>

    <!-- Messages -->
    <div id="messagesContainer" style="display:flex; flex-direction:column; gap:10px; padding:10px;"></div>

    <!-- Formulaire -->
    <form class="message-form" id="messageForm" autocomplete="off">
      <input id="messageInput" type="text" placeholder="√âcris ton message..." required>
      <button id="sendBtn" type="submit">Envoyer pour 5 cr√©dits</button>
    </form>

  </main>

  <aside class="sidebar-right">
    <a href="mes-photos.html">Mes Photos</a>
    <a href="profil.html">Mon Profil</a>
    <a href="mes-favoris.html">Mes Favoris</a>
    <a href="membres_bloques.html">Membres Bloqu√©s</a>
    <a href="achat_credits.html">Acheter Cr√©dits</a>
    <a href="parametre.html">Param√®tres</a>
  </aside>

</div>

<footer class="footer">
  <a href="#">Service Clients</a>
  <a href="#">CGV</a>
  <a href="#">Protection des donn√©es</a>
  <a href="#">Mentions l√©gales</a>
  <a href="#">EN / FR</a>
  ¬© 2025 Pourflirter. Tous droits r√©serv√©s.
</footer>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  // ‚úÖ REMPLACE ICI
  const SUPABASE_URL = "TON_SUPABASE_URL";
  const SUPABASE_ANON_KEY = "TON_SUPABASE_ANON_KEY";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const recipientNameEl = document.getElementById("recipientName");
  const recipientAvatarEl = document.getElementById("recipientAvatar");
  const myAvatarEl = document.getElementById("myAvatar");
  const messagesContainer = document.getElementById("messagesContainer");
  const messageForm = document.getElementById("messageForm");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  let myUserId = null;
  let recipientId = null;

  function getQueryParam(param) {
    return new URLSearchParams(window.location.search).get(param);
  }

  function escapeHtml(str) {
    return (str ?? "").replace(/[&<>"']/g, (m) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }

  function renderMessage({ content, created_at, sender_id }) {
    const isMine = sender_id === myUserId;
    const div = document.createElement("div");
    div.className = "message " + (isMine ? "sent" : "received");
    div.innerHTML = `
      ${escapeHtml(content)}
      <time>${new Date(created_at).toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" })}</time>
    `;
    messagesContainer.appendChild(div);
  }

  async function requireSession() {
    const { data, error } = await supabase.auth.getSession();
    if (error) throw error;
    if (!data?.session) {
      window.location.href = "connexion.html";
      return null;
    }
    return data.session;
  }

  async function loadProfiles() {
    // Moi
    const me = await supabase
      .from("profiles")
      .select("id, username, profile_photo")
      .eq("id", myUserId)
      .single();

    if (!me.error && me.data) {
      myAvatarEl.src = me.data.profile_photo || "images/utilisateur.jpg";
      myAvatarEl.alt = me.data.username || "Ma photo";
    } else {
      console.warn("Profil perso non lisible (profiles RLS?)", me.error);
    }

    // Destinataire
    const other = await supabase
      .from("profiles")
      .select("id, username, profile_photo")
      .eq("id", recipientId)
      .single();

    if (other.error || !other.data) {
      console.error("Destinataire introuvable:", other.error);
      alert("Utilisateur introuvable (profil inexistant ou acc√®s refus√©).");
      return false;
    }

    recipientNameEl.textContent = other.data.username || "Utilisateur";
    recipientAvatarEl.src = other.data.profile_photo || "images/utilisateur.jpg";
    recipientAvatarEl.alt = other.data.username || "Avatar";
    return true;
  }

  async function loadMessages() {
    messagesContainer.innerHTML = "";

    const { data, error } = await supabase
      .from("messages")
      .select("id, sender_id, receiver_id, content, created_at")
      .or(
        `and(sender_id.eq.${myUserId},receiver_id.eq.${recipientId}),and(sender_id.eq.${recipientId},receiver_id.eq.${myUserId})`
      )
      .order("created_at", { ascending: true });

    if (error) {
      console.error("Erreur chargement messages:", error);
      alert("Impossible de charger les messages (RLS/policies). Ouvre F12 > Console.");
      return;
    }

    (data || []).forEach(renderMessage);
  }

  async function sendMessage(text) {
    const { data, error } = await supabase
      .from("messages")
      .insert({ sender_id: myUserId, receiver_id: recipientId, content: text })
      .select("id, sender_id, receiver_id, content, created_at")
      .single();

    if (error) {
      console.error("Erreur envoi:", error);
      alert("Envoi impossible (RLS/policies). Ouvre F12 > Console.");
      return null;
    }
    return data;
  }

  messageForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text) return;

    sendBtn.disabled = true;
    const inserted = await sendMessage(text);
    if (inserted) {
      renderMessage(inserted);
      messageInput.value = "";
    }
    sendBtn.disabled = false;
    messageInput.focus();
  });

  logoutBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    await supabase.auth.signOut();
    window.location.href = "connexion.html";
  });

  (async function init() {
    recipientId = getQueryParam("to");
    if (!recipientId) {
      alert("Lien invalide : il manque ?to=UUID_DESTINATAIRE");
      return;
    }

    const session = await requireSession();
    if (!session) return;

    myUserId = session.user.id;

    console.log("Moi:", myUserId, "| Dest:", recipientId);

    const ok = await loadProfiles();
    if (!ok) return;

    await loadMessages();
  })();
</script>

</body>
</html>
