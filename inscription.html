<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inscription - Pourflirter</title>
  <link rel="stylesheet" href="Design/style.css" />
  <link rel="icon" type="image/jpeg" href="Image/favicon.ico.jpg" />
</head>
<body>

<main class="container">
  <h1>Nous sommes ravis que tu souhaites t'inscrire !</h1>
  <p>Chez nous, 100% de chance de flirter ❤️</p>

  <section class="form-section">
    <h2>Informations</h2>

    <form id="signup-form">
      <input type="text" id="username" placeholder="Nom d'utilisateur" required />
      <input type="email" id="email" placeholder="Email" required />
      <input type="password" id="password" placeholder="Mot de passe" required />
      <input type="date" id="birthdate" required />

      <input type="text" id="birthplace" placeholder="Ville" required />

      <label>Je suis :</label>
      <select id="gender" required>
        <option value="">-- Choisir --</option>
        <option value="homme">Homme</option>
        <option value="femme">Femme</option>
      </select>

      <label>Je recherche :</label>
      <select id="lookingFor" required>
        <option value="">-- Choisir --</option>
        <option value="homme">Homme</option>
        <option value="femme">Femme</option>
      </select>

      <div class="checkboxes">
        <input type="checkbox" id="cgv" required />
        <label for="cgv">J’accepte les CGV</label>
      </div>

      <button type="submit">S’inscrire</button>
    </form>
  </section>
</main>

<script type="module">
import { supabase } from "./supabaseClient.js";

document.getElementById("signup-form").addEventListener("submit", async (e) => {
  e.preventDefault();

  const username = document.getElementById("username").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const birthdate = document.getElementById("birthdate").value;
  const birthplace = document.getElementById("birthplace").value.trim();
  const gender = document.getElementById("gender").value;
  const lookingFor = document.getElementById("lookingFor").value;

  const { data, error } = await supabase.auth.signUp({
    email,
    password
  });

  if (error) {
    const msg = (error.message || "").toLowerCase();
    if (msg.includes("already") || msg.includes("registered") || msg.includes("exists")) {
      alert("❌ Cet email est déjà utilisé. Connecte-toi.");
      window.location.href = "index.html";
      return;
    }
    alert("Erreur : " + error.message);
    return;
  }

  const userId = data?.user?.id;

  // Si email-confirmation est bien OFF, on a une session directe.
  // Si jamais session est null quand même, on tente de récupérer la session.
  const { data: sessionData } = await supabase.auth.getSession();
  const session = sessionData?.session;

  if (!session) {
    alert("✅ Compte créé, mais session non active. Connecte-toi.");
    window.location.href = "index.html";
    return;
  }

  const { error: profileError } = await supabase
    .from("profiles")
    .insert({
      id: userId,
      username,
      birthdate,
      birthplace,
      gender,
      lookingFor,
      search_radius: 20
    });

  if (profileError) {
    alert("Erreur en enregistrant le profil : " + profileError.message);
    return;
  }

  // ✅ REDIRECTION DIRECTE
  window.location.href = "accueil.html";
});
</script>
</body>
</html>
